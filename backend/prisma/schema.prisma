// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model - represents API users who authenticate with Clerk
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Clerk Authentication
  clerkId         String   @unique // Clerk user ID
  email           String?
  emailVerified   Boolean  @default(false)
  lastLoginAt     DateTime?
  
  // OAuth Provider Data (JSON for flexibility)
  providerData    Json? // Store provider-specific data (firstName, lastName, imageUrl, etc.)

  // Relationships - profiles created by this API user
  profiles Profile[]

  @@map("users")
}

// Profile model - represents a person in the KYC flow (end customers)
model Profile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Owner of this profile (API user)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Basic profile information
  fullName       String?
  identityNumber String?
  dateOfBirth    DateTime?
  gender         String?
  nationality    String?
  country        String?

  // Contact information (optional)
  email       String?
  phoneNumber String?

  // Profile status
  status ProfileStatus @default(PENDING)

  // Relationships
  idCardValidations IdCardValidation[]
  selfieValidations SelfieValidation[]
  amlCheck          AmlCheck?
  ValidationSession ValidationSession[]

  // Unique constraint for country + nationality number
  @@unique([country, identityNumber], name: "unique_country_identity")
  @@map("profiles")
}

// ID Card Validation model
model IdCardValidation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign key to profile
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Document information
  countryCode   String
  frontImageUrl String
  backImageUrl  String?

  // Extracted data
  fullName       String?
  identityNumber String?
  dateOfBirth    DateTime?
  expiryDate     DateTime?
  gender         String?
  nationality    String?
  serialNumber   String?
  mrz            String?
  address        String?

  // Assessment fields
  documentCondition DocumentCondition?

  // Confidence scores (0-1)
  fullNameConfidence       Float?
  identityNumberConfidence Float?
  dateOfBirthConfidence    Float?
  expiryDateConfidence     Float?
  imageQuality             Float?

  // Validation result
  status           ValidationStatus @default(PENDING)
  errors           Json? // Array of error objects
  rejectionReasons Json? // Array of rejection reason strings

  @@map("id_card_validations")
}

// Selfie Validation model
model SelfieValidation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign key to profile
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Image URLs
  idPhotoUrl String
  selfieUrls Json // Array of selfie URLs

  // Verification results
  isMatch            Boolean?
  matchConfidence    Float? // 0-100 percentage
  spoofingRisk       Float? // 0-1 risk score
  faceCount          Int?
  imageQualityIssues Json? // Array of quality issue strings

  // Assessment fields
  lightingCondition LightingCondition?
  faceSize          FaceSize?
  faceCoverage      FaceCoverage?

  // Confidence scores (0-1)
  imageQuality            Float?
  faceDetectionConfidence Float?

  // Validation result
  status           ValidationStatus @default(PENDING)
  errors           Json? // Array of error objects
  rejectionReasons Json? // Array of rejection reason strings

  @@map("selfie_validations")
}

// AML (Anti-Money Laundering) Check model
model AmlCheck {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign key to profile (one-to-one)
  profileId String  @unique
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // AML check data
  riskScore         Float? // 0-1 risk score
  riskLevel         AmlRiskLevel?
  sanctionsCheck    Boolean?
  pepCheck          Boolean? // Politically Exposed Person check
  adverseMediaCheck Boolean?

  // Check results
  status AmlStatus @default(PENDING)
  errors Json? // Array of error objects
  notes  String?

  // External service data
  externalCheckId  String?
  externalProvider String?

  @@map("aml_checks")
}

// Threshold Configuration model - for dynamic threshold management
model ThresholdConfig {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Configuration details
  category       String // e.g., "ID_VALIDATION", "SELFIE_VALIDATION", "AML"
  fieldName      String // e.g., "fullNameConfidence", "matchConfidence"
  thresholdValue Float // The threshold value
  dataType       String // "FLOAT", "INTEGER", "BOOLEAN"

  // Metadata
  description String?
  isActive    Boolean @default(true)
  version     Int     @default(1)

  // Unique constraint for category + fieldName
  @@unique([category, fieldName], name: "unique_category_field")
  @@map("threshold_configs")
}

// Validation Session model - tracks the overall KYC session
model ValidationSession {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Session information
  sessionToken String  @unique
  profileId    String
  profile      Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Session status
  status      SessionStatus @default(ACTIVE)
  completedAt DateTime?

  // Session metadata
  userAgent  String?
  ipAddress  String?
  deviceInfo Json?

  @@map("validation_sessions")
}

// Audit Log model - for tracking all changes and actions
model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Audit information
  entityType String // "Profile", "IdCardValidation", etc.
  entityId   String
  action     String // "CREATE", "UPDATE", "DELETE", "VALIDATE"

  // Change details
  oldValues Json?
  newValues Json?

  // Context
  userId    String?
  sessionId String?
  ipAddress String?
  userAgent String?

  @@map("audit_logs")
}

// Enums
enum ProfileStatus {
  PENDING
  APPROVED
  REJECTED
  FAILED
  UNDER_REVIEW
}

enum ValidationStatus {
  PENDING
  APPROVED
  REJECTED
  FAILED
  UNDER_REVIEW
}

enum DocumentCondition {
  GOOD
  DAMAGED
  POOR
}

enum LightingCondition {
  GOOD
  POOR
  INSUFFICIENT
}

enum FaceSize {
  ADEQUATE
  TOO_SMALL
  TOO_LARGE
}

enum FaceCoverage {
  CLEAR
  PARTIALLY_COVERED
  FULLY_COVERED
}

enum AmlRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AmlStatus {
  PENDING
  CLEAR
  FLAGGED
  FAILED
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}
